
<span id="title_page.xhtml"></span>



<div id="title_page.xhtml#cover-image">



[[File:images/title_page.jpg|SuiteCRM for Developers]]



</div>

<span id="verso_page.xhtml"></span>



== SuiteCRM for Developers ==



=== Getting started with developing for SuiteCRM ===



 



==== Jim Mackin ====



 



This book is for sale at http://leanpub.com/suitecrmfordevelopers



This version was published on 2015-05-22



[[File:images/leanpub-logo.png|publisher's logo]]



*   *   *   *   *



This is a [http://leanpub.com Leanpub] book. Leanpub empowers authors and publishers with the Lean Publishing process. [http://leanpub.com/manifesto Lean Publishing] is the act of publishing an in-progress ebook using lightweight tools and many iterations to get reader feedback, pivot until you have the right book and build traction once you do.



*   *   *   *   *







<div>



© 2015 Jim Mackin



</div>

<span id="toc.xhtml"></span>



<div>



== Table of Contents ==



* [[#chap00.xhtml#leanpub-auto-introduction|<span class="section-number">1. </span>Introduction]]

** [[#chap00.xhtml#leanpub-auto-what-is-suitecrm|What is SuiteCRM]]

** [[#chap00.xhtml#leanpub-auto-this-book|This book]]

** [[#chap00.xhtml#leanpub-auto-reading-this-book|Reading this book]]

** [[#chap00.xhtml#leanpub-auto-setting-up-suitecrm|Setting up SuiteCRM]]

** [[#chap00.xhtml#leanpub-auto-initial-tweaks|Initial Tweaks]]

* [[#chap01.xhtml#leanpub-auto-suitecrm-directory-structure|<span class="section-number">2. </span>SuiteCRM Directory Structure]]

* [[#chap02.xhtml#working-with-beans-chapter|<span class="section-number">3. </span>Working with Beans]]

** [[#chap02.xhtml#leanpub-auto-beanfactory|BeanFactory]]

** [[#chap02.xhtml#leanpub-auto-sugarbean|SugarBean]]

** [[#chap02.xhtml#leanpub-auto-searching-for-beans|Searching for beans]]

** [[#chap02.xhtml#leanpub-auto-accessing-fields|Accessing fields]]

** [[#chap02.xhtml#leanpub-auto-related-beans|Related beans]]

* [[#chap03.xhtml#vardefs-chapter|<span class="section-number">4. </span>Vardefs]]

** [[#chap03.xhtml#leanpub-auto-what-are-vardefs|What are Vardefs]]

** [[#chap03.xhtml#leanpub-auto-defining-vardefs|Defining Vardefs]]

* [[#chap04.xhtml#leanpub-auto-views|<span class="section-number">5. </span>Views]]

** [[#chap04.xhtml#leanpub-auto-location|Location]]

** [[#chap04.xhtml#leanpub-auto-customising|Customising]]

* [[#chap05.xhtml#metadata-chapter|<span class="section-number">6. </span>Metadata]]

** [[#chap05.xhtml#leanpub-auto-intro|Intro]]

** [[#chap05.xhtml#leanpub-auto-location-1|Location]]

** [[#chap05.xhtml#leanpub-auto-customising-1|Customising]]

** [[#chap05.xhtml#leanpub-auto-different-metadata|Different metadata]]

* [[#chap06.xhtml#leanpub-auto-controllers|<span class="section-number">7. </span>Controllers]]

** [[#chap06.xhtml#leanpub-auto-customising-controllers|Customising controllers]]

* [[#chap07.xhtml#entry-point-chapter|<span class="section-number">8. </span>Entry Points]]

** [[#chap07.xhtml#leanpub-auto-creating-an-entry-point|Creating an entry point]]

* [[#chap08.xhtml#language-chapter|<span class="section-number">9. </span>Language Strings]]

** [[#chap08.xhtml#leanpub-auto-module-strings|Module Strings]]

** [[#chap08.xhtml#leanpub-auto-application-strings|Application Strings]]

** [[#chap08.xhtml#leanpub-auto-application-list-strings|Application List Strings]]

** [[#chap08.xhtml#leanpub-auto-why-and-when-to-customise|Why and when to customise]]

** [[#chap08.xhtml#leanpub-auto-usage|Usage]]

* [[#chap09.xhtml#config-chapter|<span class="section-number">10. </span>Config]]

** [[#chap09.xhtml#leanpub-auto-the-config-files|The config files]]

** [[#chap09.xhtml#leanpub-auto-using-config-options|Using config options]]

* [[#chap10.xhtml#logging-chapter|<span class="section-number">11. </span>Logging]]

** [[#chap10.xhtml#leanpub-auto-logging-messages|Logging messages]]

** [[#chap10.xhtml#leanpub-auto-logging-output|Logging output]]

** [[#chap10.xhtml#leanpub-auto-log-levels|Log levels]]

* [[#chap11.xhtml#logic-hooks-chapter|<span class="section-number">12. </span>Logic Hooks]]

** [[#chap11.xhtml#leanpub-auto-intro-1|Intro]]

** [[#chap11.xhtml#leanpub-auto-types|Types]]

** [[#chap11.xhtml#leanpub-auto-application-hooks|Application Hooks]]

** [[#chap11.xhtml#leanpub-auto-user-hooks|User Hooks]]

** [[#chap11.xhtml#leanpub-auto-module-hooks|Module Hooks]]

** [[#chap11.xhtml#leanpub-auto-job-queue-hooks|Job Queue Hooks]]

** [[#chap11.xhtml#leanpub-auto-implementing|Implementing]]

** [[#chap11.xhtml#leanpub-auto-tips|Tips]]

* [[#chap12.xhtml#scheduled-tasks-chapter|<span class="section-number">13. </span>Scheduled Tasks]]

** [[#chap12.xhtml#leanpub-auto-intro-2|Intro]]

** [[#chap12.xhtml#leanpub-auto-scheduler|Scheduler]]

** [[#chap12.xhtml#leanpub-auto-job-queue|Job Queue]]

** [[#chap12.xhtml#leanpub-auto-debugging|Debugging]]

* [[#chap13.xhtml#extensions-chapter|<span class="section-number">14. </span>Extension Framework]]

** [[#chap13.xhtml#leanpub-auto-introduction-1|Introduction]]

** [[#chap13.xhtml#leanpub-auto-standard-extensions|Standard Extensions]]

** [[#chap13.xhtml#leanpub-auto-custom-extensions|Custom Extensions]]

* [[#chap14.xhtml#module-installer-chapter|<span class="section-number">15. </span>Module Installer]]

** [[#chap14.xhtml#leanpub-auto-manifestphp|manifest.php]]

** [[#chap14.xhtml#leanpub-auto-types-1|Types]]

* [[#chap15.xhtml#leanpub-auto-api|<span class="section-number">16. </span>API]]

** [[#chap15.xhtml#leanpub-auto-using-the-api|Using the API]]

** [[#chap15.xhtml#leanpub-auto-adding-custom-api-methods|Adding custom API methods]]

* [[#chap16.xhtml#leanpub-auto-best-practices|<span class="section-number">17. </span>Best Practices]]

** [[#chap16.xhtml#leanpub-auto-development-instances|Development instances]]

** [[#chap16.xhtml#leanpub-auto-version-control|Version control]]

** [[#chap16.xhtml#leanpub-auto-backup|Backup]]

** [[#chap16.xhtml#leanpub-auto-be-upgrade-safe|Be upgrade safe]]

** [[#chap16.xhtml#leanpub-auto-use-appropriate-log-levels|Use appropriate log levels]]

** [[#chap16.xhtml#leanpub-auto-long-running-logic-hooks|Long running logic hooks]]

** [[#chap16.xhtml#leanpub-auto-minimise-sql|Minimise SQL]]

** [[#chap16.xhtml#leanpub-auto-sql-use|SQL Use]]

** [[#chap16.xhtml#leanpub-auto-entry-check|Entry check]]

** [[#chap16.xhtml#leanpub-auto-redirect-after-post|Redirect after post]]

* [[#chap17.xhtml#leanpub-auto-performance-tweaks|<span class="section-number">18. </span>Performance Tweaks]]

** [[#chap17.xhtml#leanpub-auto-server|Server]]

** [[#chap17.xhtml#leanpub-auto-indexes|Indexes]]

** [[#chap17.xhtml#leanpub-auto-config-changes|Config Changes]]

* [[#chap18.xhtml#leanpub-auto-further-resources|<span class="section-number">19. </span>Further Resources]]

** [[#chap18.xhtml#leanpub-auto-suitecrm-website|SuiteCRM Website]]

** [[#chap18.xhtml#leanpub-auto-external-suitecrm-resources|External SuiteCRM Resources]]

** [[#chap18.xhtml#leanpub-auto-sugarcrm-resources|SugarCRM Resources]]

** [[#chap18.xhtml#leanpub-auto-technical-links|Technical Links]]

** [[#chap18.xhtml#leanpub-auto-other-links|Other Links]]

* [[#chap19.xhtml#appendix-a|<span class="section-number">20. </span>Appendix A - Code Examples]]

** [[#chap19.xhtml#leanpub-auto-metadata|Metadata]]

** [[#chap19.xhtml#leanpub-auto-module-installer|Module Installer]]

* [[#chap20.xhtml#appendix-b|<span class="section-number">21. </span>Appendix B - API Methods]]

** [[#chap20.xhtml#leanpub-auto-methods-1|Methods]]





</div>

<span id="chap00.xhtml"></span>



<div>



== <span class="section-number">1. </span>Introduction ==



=== What is SuiteCRM ===



The story of [https://www.suitecrm.com SuiteCRM] starts with SugarCRM. SugarCRM was founded in 2004 and consisted of an open source version (called Community Edition) and various paid for versions. However trouble started brewing when it appeared that SugarCRM would not be releasing a Community Edition of SugarCRM 7 and would be providing limited, if any, updates to the Community Edition.



Enter SuiteCRM. SalesAgility forked Community Edition to create SuiteCRM and also added various open source plugins to add improved functionality.



=== This book ===



This book is intended for developers who are familiar (or at least acquainted) with using SuiteCRM but want to perform their own customisations. SuiteCRM is a large and mature piece of software so it is impractical for a book to cover all aspects of the software. I’ve tried to add the most important parts which should allow you to make the changes you need in 99% of situations. There is a further resources chapter at the end of this book to help out in those 1% of cases. With that being said if you feel there is anything important I have left out (or worse, anything incorrect in the book) please let me know. I can be contacted at [http://www.jsmackin.co.uk JSMackin.co.uk].



=== Reading this book ===



Each chapter in this book is intended to be self contained so the reader can jump to interesting chapters. Where there is some overlap this is usually indicated with links to the relevant chapters.



Some parts of this book may refer to file paths or other parts of code that can have a variable value, for example controller names contain the module name or a file with an arbitrary name. In this case these will be marked in the form <code>&lt;TheModuleName&gt;</code>, <code>&lt;TheFileName&gt;</code> or something else suitable. In these cases you can substitute something appropriate (such as <code>Accounts</code> or <code>MyNewFile</code>).



=== Setting up SuiteCRM ===



In this book we’ll be using SuiteCRM v7.1.5 which is the latest at time of writing. For up to date versions of the installation instructions see the SuiteCRM wiki at [https://suitecrm.com/wiki/index.php/Installation suitecrm.com/wiki/index.php/Installation].



==== Website ====



The SuiteCRM installer can be found at [https://suitecrm.com/ SuiteCRM.com]. I would recommend SuiteCRM MAX as I prefer to start with a full interface and customise it as needed.



==== GitHub ====



SuiteCRM is also available on [http://github.com GitHub] at [https://github.com/salesagility/SuiteCRM github.com/salesagility/SuiteCRM]. Each SuiteCRM version is tagged so you can easily grab the version you need.



=== Initial Tweaks ===



After the initial install there are a few tweaks you may want to make on an instance you are developing on. These changes should improve your development flow and productivity as well as help identify issues if they occur.



==== Developer Mode ====



SuiteCRM will cache various files that it processes, such as Smarty templates. Developer mode will turn off some of the caching so that changes to files will be seen immediately (though this isn’t always the case - as is the case with [[#chap13.xhtml#extensions-chapter|extensions]]). This can be enabled either through the config file or via the General settings page inside admin.



==== Log Level ====



The default log level of SuiteCRM is <code>fatal</code>. This is a good default for production instances but you may want to increase the log level to <code>info</code> or <code>debug</code>. This will make the log output more verbose so, should anything go wrong, you’ll have something to refer to. See the [[#chap10.xhtml#logging-chapter|chapter on logging]] for more information.



==== Display errors ====



You’ll also want to turn off display errors. Unfortunately at the moment SuiteCRM has various notices and warnings out of the box. With <code>display_errors</code> on this can sometimes cause AJAX pages and the link to break.



With this being said you should be checking the PHP error logs or selectively enabling<br />

<code>display_errors</code> to ensure that the code you are creating is not creating additional notices, warnings or errors.



==== XDebug ====



[http://xdebug.org XDebug] is a PHP extension which provides profiling and debugging capabilities to PHP. This can massively improve developer productivity by simplifying development and, particularly, tracking down any issues. See the XDebug site for information on XDebug.





</div>

<span id="chap01.xhtml"></span>



<div>



== <span class="section-number">2. </span>SuiteCRM Directory Structure ==



; <code>cache</code>

: Contains cache files used by SuiteCRM including compiled smarty templates, grouped vardefs, minified and grouped JavaScript. Some modules and custom modules may also store (temporary) module specific info here.

; <code>custom</code>

: Contains user and developer customisations to SuiteCRM. Also contains some SuiteCRM code to maintain compatibility with SugarCRM. However this is likely to change in the future.

; <code>data</code>

: Stores the classes and files used to deal with SugarBeans and their relationships.

; <code>examples</code>

: Contains a few basic examples of lead capture and API usage. However these are very outdated.

; <code>include</code>

: Contains the bulk of non module and non data SuiteCRM code.

; <code>install</code>

: Code used by the SuiteCRM installer.

; <code>jssource</code>

: The <code>jssource</code> folder contains the unminified source of some of the JavaScript files used within SuiteCRM.

; <code>metadata</code>

: Stores relationship metadata for the various stock SuiteCRM modules. This should not be confused with module metadata which contains information on view, dashlet and search definitions.

; <code>mobile</code>

: Stores code for the [http://www.quickcrm.fr QuickCRM] mobile app.

; <code>ModuleInstall</code>

: Code for the module installer.

; <code>modules</code>

: Contains the code for any stock or custom SuiteCRM modules.

; <code>service</code>

: Code for the SuiteCRM Soap and REST APIs.

; <code>themes</code>

: Code, data and images for the bundled SuiteCRM theme.

; <code>upload</code>

: The <code>upload</code> folder contains documents that have been uploaded to SuiteCRM. The names of the files comes from the ID of the matching Document Revision/Note. <code>upload</code>/<code>upgrades</code> will also contain various upgrade files and the packages of installed modules.

;  <code>log4php</code>, <code>soap</code>, <code>XTemplate</code>, <code>Zend</code> 

: Source code for various libraries used by SuiteCRM some of which are deprecated.





</div>

<span id="chap02.xhtml"></span>



<div>



== <span class="section-number">3. </span>Working with Beans ==



Beans are the Model in SuiteCRM’s MVC (Model View Controller) architecture. They allow retrieving data from the database as objects and allow persisting and editing records. This section will go over the various ways of working with beans.



=== BeanFactory ===



The BeanFactory allows dynamically loading bean instances or creating new records. For example to create a new bean you can use:



<div class="code-block">



Example 3.1: Creating a new Bean using the BeanFactory





-----



<div class="highlight">



<pre>1 $bean = BeanFactory::newBean('&lt;TheModule&gt;');

2 //For example a new account bean:

3 $accountBean = BeanFactory::newBean('Accounts');</pre>



</div>



-----





</div>

Retrieving an existing bean can be achieved in a similar manner:



<div class="code-block">



Example 3.2: Retrieving a bean with the BeanFactory





-----



<div class="highlight">



<pre>1 $bean = BeanFactory::getBean('&lt;TheModule&gt;', $beanId);

2 //For example to retrieve an account id

3 $bean = BeanFactory::getBean('Accounts', $beanId);</pre>



</div>



-----





</div>

<code>getBean</code> will return an unpopulated bean object if <code>$beanId</code> is not supplied or if there’s no such record. Retrieving an unpopulated bean can be useful if you wish to use the static methods of the bean (for example see the Searching for Beans section). To deliberately retrieve an unpopulated bean you can omit the second argument of the <code>getBean</code> call. I.e.



<div class="code-block">



Example 3.3: Retrieving an unpopulated bean





-----



<div class="highlight">



<pre>1 $bean = BeanFactory::getBean('&lt;TheModule&gt;');</pre>



</div>



-----





</div>

{|

|width="50%"| [[File:images/leanpub_warning.png|50px|class=sidebar-image|warning]]

|width="50%"| <code>BeanFactory::getBean</code> caches ten results. This can cause odd behaviour if you call <code>getBean</code> again and get a cached copy. Any calls that return a cached copy will return the same instance. This means changes to one of the beans will be reflected in all the results.

|}



Using BeanFactory ensures that the bean is correctly set up and the necessary files are included etc.



=== SugarBean ===



The SugarBean is the parent bean class and all beans in SuiteCRM extend this class. It provides various ways of retrieving and interacting with records.



=== Searching for beans ===



The following examples show how to search for beans using a bean class. The examples provided assume that an account bean is available names $accountBean. This may have been retrieved using the getBean call mentioned in the BeanFactory section e.g.



<div class="code-block">



Example 3.4: Retrieving an unpopulated account bean





-----



<div class="highlight">



<pre>$accountBean = BeanFactory::getBean('Accounts');</pre>



</div>



-----





</div>

==== get_list ====



The get_list method allows getting a list of matching beans and allows paginating the results.



<div class="code-block">



Example 3.5: get_list method signature





-----



<div class="highlight">



<pre>1 get_list(

2     $order_by = &quot;&quot;,

3     $where = &quot;&quot;,

4     $row_offset = 0,

5     $limit=-1,

6     $max=-1,

7     $show_deleted = 0)</pre>



</div>



-----





</div>

; $order_by

: Controls the ordering of the returned list. <code>$order_by</code> is specified as a string that will be used in the SQL ORDER BY clause e.g. to sort by name you can simply pass <code>name</code>, to sort by date_entered descending use <code>date_entered DESC</code>. You can also sort by multiple fields. For example sorting by date_modified and id descending <code>date_modified, id DESC</code>.

; $where

: Allows filtering the results using an SQL WHERE clause. <code>$where</code> should be a string containing the SQL conditions. For example in the contacts module searching for contacts with specific first names we might use <code>contacts.first_name='Jim'</code>. Note that we specify the table, the query may end up joining onto other tables so we want to ensure that there is no ambiguity in which field we target.

; $row_offset

: The row to start from. Can be used to paginate the results.

; $limit

: The maximum number of records to be returned by the query. -1 means no limit.

; $max

: The maximum number of entries to be returned per page. -1 means the default max (usually 20).

; $show_deleted

: Whether to include deleted results.



===== Results =====



get_list will return an array. This will contain the paging information and will also contain the list of beans. This array will contain the following keys:



; list

: An array of the beans returned by the list query

; row_count

: The total number of rows in the result

; next_offset

: The offset to be used for the next page or -1 if there are no further pages.

; previous_offset

: The offset to be used for the previous page or -1 if this is the first page.

; current_offset

: The offset used for the current results.



===== Example =====



Let’s look at a concrete example. We will return the third page of all accounts with the industry <code>Media</code> using 10 as a page size and ordered by name.



<div class="code-block">



Example 3.6: Example get_list call





-----



<div class="highlight">



<pre> 1 $beanList = $accountBean-&gt;get_list(

 2                                 //Order by the accounts name

 3                                 'name',

 4                                 //Only accounts with industry 'Media'

 5                                 &quot;accounts.industry = 'Media'&quot;,

 6                                 //Start with the 30th record (third page)

 7                                 30,

 8                                 //No limit - will default to max page size

 9                                 -1,

10                                 //10 items per page

11                                 10);</pre>



</div>



-----





</div>

This will return:



<div class="code-block">



Example 3.7: Example get_list results





-----



<div class="highlight">



<pre> 1 Array

 2 (

 3     //Snipped for brevity - the list of Account SugarBeans

 4     [list] =&gt; Array()

 5     //The total number of results

 6     [row_count] =&gt; 36

 7     //This is the last page so the next offset is -1

 8     [next_offset] =&gt; -1

 9     //Previous page offset

10     [previous_offset] =&gt; 20

11     //The offset used for these results

12     [current_offset] =&gt; 30

13 )</pre>



</div>



-----





</div>

==== get_full_list ====



<code>get_list</code> is useful when you need paginated results. However if you are just interested in getting a list of all matching beans you can use <code>get_full_list</code>. The <code>get_full_list</code> method signature looks like this:



<div class="code-block">



Example 3.8: get_full_list method signature





-----



<div class="highlight">



<pre>1 get_full_list(

2             $order_by = &quot;&quot;,

3             $where = &quot;&quot;,

4             $check_dates=false,

5             $show_deleted = 0</pre>



</div>



-----





</div>

These arguments are identical to their usage in <code>get_list</code> the only difference is the <code>$check_dates</code> argument. This is used to indicate whether the date fields should be converted to their display values (i.e. converted to the users date format).



===== Results =====



The get_full_list call simply returns an array of the matching beans



===== Example =====



Let’s rework our <code>get_list</code> example to get the full list of matching accounts:



<div class="code-block">



Example 3.9: Example get_full_list call





-----



<div class="highlight">



<pre>1 $beanList = $accountBean-&gt;get_full_list(

2                                 //Order by the accounts name

3                                 'name',

4                                 //Only accounts with industry 'Media'

5                                 &quot;accounts.industry = 'Media'&quot;

6                                 );</pre>



</div>



-----





</div>

==== retrieve_by_string_fields ====



Sometimes you only want to retrieve one row but may not have the id of the record. <code>retrieve_by_string_fields</code> allows retrieving a single record based on matching string fields.



<div class="code-block">



Example 3.10: retrieve_by_string_fields method signature





-----



<div class="highlight">



<pre>1 retrieve_by_string_fields(

2                           $fields_array,

3                           $encode=true,

4                           $deleted=true)</pre>



</div>



-----





</div>

; $fields_array

: An array of field names to the desired value.

; $encode

: Whether or not the results should be HTML encoded.

; $deleted

: Whether or not to add the deleted filter.



{|

|width="50%"| [[File:images/leanpub_warning.png|50px|class=sidebar-image|warning]]

|width="50%"| Note here that, confusingly, the deleted flag works differently to the other methods we have looked at. It flags whether or not we should filter out deleted results. So if true is passed then the deleted results will ''not'' be included.

|}



===== Results =====



retrieve_by_string_fields returns a single bean as it’s result or null if there was no matching bean.



===== Example =====



For example to retrieve the account with name <code>Tortoise Corp</code> and account_type <code>Customer</code> we could use the following:



<div class="code-block">



Example 3.11: Example retrieve_by_string_fields call





-----



<div class="highlight">



<pre>1 $beanList = $accountBean-&gt;retrieve_by_string_fields(

2                                 array(

3                                   'name' =&gt; 'Tortoise Corp',

4                                   'account_type' =&gt; 'Customer'

5                                 )

6                               );</pre>



</div>



-----





</div>

=== Accessing fields ===



If you have used one of the above methods we now have a bean record. This bean represents the record that we have retrieved. We can access the fields of that record by simply accessing properties on the bean just like any other PHP object. Similarly we can use property access to set the values of beans. Some examples are as follows:



<div class="code-block">



Example 3.12: Accessing fields examples





-----



<div class="highlight">



<pre> 1 //Get the Name field on account bean

 2 $accountBean-&gt;name;

 3 

 4 //Get the Meeting start date

 5 $meetingBean-&gt;date_start;

 6 

 7 //Get a custom field on a case

 8 $caseBean-&gt;third_party_code_c;

 9 

10 //Set the name of a case

11 $caseBean-&gt;name = 'New Case name';

12 

13 //Set the billing address post code of an account

14 $accountBean-&gt;billing_address_postalcode = '12345';</pre>



</div>



-----





</div>

When changes are made to a bean instance they are not immediately persisted. We can save the changes to the database with a call to the beans <code>save</code> method. Likewise a call to <code>save</code> on a brand new bean will add that record to the database:



<div class="code-block">



Example 3.13: Persisting bean changes





-----



<div class="highlight">



<pre> 1 //Get the Name field on account bean

 2 $accountBean-&gt;name = 'New account name';

 3 //Set the billing address post code of an account

 4 $accountBean-&gt;billing_address_postalcode = '12345';

 5 //Save both changes.

 6 $accountBean-&gt;save();

 7 

 8 //Create a new case (see the BeanFactory section)

 9 $caseBean = BeanFactory::newBean('Cases');

10 //Give it a name and save

11 $caseBean-&gt;name = 'New Case name';

12 $caseBean-&gt;save();</pre>



</div>



-----





</div>

{|

|width="50%"| [[File:images/leanpub_info-circle.png|50px|class=sidebar-image|information]]

|width="50%"| Whether to save or update a bean is decided by checking the <code>id</code> field of the bean. If <code>id</code> is set then SuiteCRM will attempt to perform an update. If there is no <code>id</code> then one will be generated and a new record will be inserted into the database. If for some reason you have supplied an <code>id</code> but the record is new (perhaps in a custom import script) then you can set <code>new_with_id</code> to true on the bean to let SuiteCRM know that this record is new.

|}



=== Related beans ===



We have seen how to save single records but, in a CRM system, relationships between records are as important as the records themselves. For example an account may have a list of cases associated with it, a contact will have an account that it falls under etc. We can get and set relationships between beans using several methods.



==== get_linked_beans ====



The <code>get_linked_beans</code> method allows retrieving a list of related beans for a given record.



<div class="code-block">



Example 3.14: get_linked_beans method signature





-----



<div class="highlight">



<pre>1 get_linked_beans(

2                 $field_name,

3                 $bean_name,

4                 $sort_array = array(),

5                 $begin_index = 0,

6                 $end_index = -1,

7                 $deleted=0,

8                 $optional_where=&quot;&quot;);</pre>



</div>



-----





</div>

; $field_name

: The link field name for this link. Note that this is not the same as the name of the relationship. If you are unsure of what this should be you can take a look into the cached vardefs of a module in <code>cache/modules/&lt;TheModule&gt;/&lt;TheModule&gt;Vardefs.php</code> for the link definition.

; $bean_name

: The name of the bean that we wish to retrieve.

; $sort_array

: This is a legacy parameter and is unused.

; $begin_index

: Skips the initial <code>$begin_index</code> results. Can be used to paginate.

; $end_index

: Return up to the <code>$end_index</code> result. Can be used to paginate.

; $deleted

: Controls whether deleted or non deleted records are shown. If true only deleted records will be returned. If false only non deleted records will be returned.

; $optional_where

: Allows filtering the results using an SQL WHERE clause. See the <code>get_list</code> method for more details.



===== Results =====



<code>get_linked_beans</code> returns an array of the linked beans.



===== Example =====



<div class="code-block">



Example 3.15: Example get_linked_beans call





-----



<div class="highlight">



<pre>1 $accountBean-&gt;get_linked_beans(

2                 'contacts',

3                 'Contacts',

4                 array(),

5                 0,

6                 10,

7                 0,

8                 &quot;contacts.primary_address_country = 'USA'&quot;);</pre>



</div>



-----





</div>

==== relationships ====



In addition to the <code>get_linked_beans</code> call you can also load and access the relationships more directly.



===== Loading =====



Before accessing a relationship you must use the <code>load_relationship</code> call to ensure it is available. This call takes the link name of the relationship (not the name of the relationship). As mentioned previously you can find the name of the link in <code>cache/modules/&lt;TheModule&gt;/&lt;TheModule&gt;Vardefs.php</code> if you’re not sure.



<div class="code-block">



Example 3.16: Loading a relationship





-----



<div class="highlight">



<pre>1 //Load the relationship

2 $accountBean-&gt;load_relationship('contacts');

3 //Can now call methods on the relationship object:

4 $contactIds = $accountBean-&gt;contacts-&gt;get();</pre>



</div>



-----





</div>

===== Methods =====



====== <code>get</code> ======



Returns the ids of the related records in this relationship e.g for the account - contacts relationship in the example above it will return the list of ids for contacts associated with the account.



====== <code>getBeans</code> ======



Similar to <code>get</code> but returns an array of beans instead of just ids.



{|

|width="50%"| [[File:images/leanpub_warning.png|50px|class=sidebar-image|warning]]

|width="50%"| <code>getBeans</code> will load the full bean for each related record. This may cause poor performance for relationships with a large number of beans.

|}



====== <code>add</code> ======



Allows relating records to the current bean. <code>add</code> takes a single id or bean or an array of ids or beans. If the bean is available this should be used since it prevents reloading the bean. For example to add a contact to the relationship in our example we can do the following:



<div class="code-block">



Example 3.18: Adding a new contact to a relationship





-----



<div class="highlight">



<pre> 1 //Load the relationship

 2 $accountBean-&gt;load_relationship('contacts');

 3 

 4 //Create a new demo contact

 5 $contactBean = BeanFactory::newBean();

 6 $contactBean-&gt;first_name = 'Jim';

 7 $contactBean-&gt;last_name = 'Mackin';

 8 $contactBean-&gt;save();

 9 

10 //Link the bean to $accountBean

11 $accountBean-&gt;contacts-&gt;add($contactBean);</pre>



</div>



-----





</div>

====== <code>delete</code> ======



<code>delete</code> allows unrelating beans. Counter-intuitively it accepts the ids of both the bean and the related bean. For the related bean you should pass the bean if it is available e.g when unrelating an account and contact:



<div class="code-block">



Example 3.19: Removing a new contact from a relationship





-----



<div class="highlight">



<pre>1 //Load the relationship

2 $accountBean-&gt;load_relationship('contacts');

3 

4 //Unlink the contact from the account - assumes $contactBean is a Contact SugarB\

5 ean

6 $accountBean-&gt;contacts-&gt;delete($accountBean-&gt;id, $contactBean);</pre>



</div>



-----





</div>

{|

|width="50%"| [[File:images/leanpub_warning.png|50px|class=sidebar-image|warning]]

|width="50%"| Be careful with the delete method. Omitting the second argument will cause all relationships for this link to be removed.

|}





</div>

<span id="chap03.xhtml"></span>



<div>



== <span class="section-number">4. </span>Vardefs ==



=== What are Vardefs ===



The Vardefs are used to supply information to SuiteCRM about a particular bean. These generally specify the fields, relationships and indexes in a given module as well as additional information such as whether it is audited, the table name etc.



=== Defining Vardefs ===



==== Module ====



Vardefs are initially defined in their respective modules folder. For the Accounts module this will be in modules/Accounts/vardefs.php. The information is stored in an array named $dictionary using the module name as the key. For Accounts this will be <code>$dictionary['Account']</code>. Let’s look at the Account vardefs (which have been edited for brevity):



<div class="code-block">



Example 4.1: Account Vardefs





-----



<div class="highlight">



<pre> 1 $dictionary['Account'] =

 2 array(

 3 	'table' =&gt; 'accounts',

 4 	'audited'=&gt;true,

 5 	'unified_search' =&gt; true,

 6 	'unified_search_default_enabled' =&gt; true,

 7 	'duplicate_merge'=&gt;true,

 8 	'comment' =&gt; 'Accounts are organizations or entities that ...',

 9 	'fields' =&gt; array (

10 	  //Snipped for brevity. See the fields section.

11 	),

12 	'indices' =&gt; array (

13 	  //Snipped for brevity. See the indices section.

14 	),

15 	'relationships' =&gt; array (

16 	  //Snipped for brevity. See the relationship section.

17 	),

18 	//This enables optimistic locking for Saves From EditView

19 	'optimistic_locking'=&gt;true,

20 );

21 

22 VardefManager::createVardef(

23 	'Accounts',

24 	'Account',

25 	array('default', 'assignable','company',)

26 );</pre>



</div>



-----





</div>

===== Keys =====



The following are some of the keys that can be specified for the vardefs. Fields, indices and relationships are covered in their own sections.



; <code>table</code>

: The database table name for this module.

; <code>audited</code>

: Whether or not this module should be audited. Note that <code>audited</code> must also be set at the fields level for a field to be audited.

; <code>unified_search</code>

: Whether this module can be searchable via the global search.

; <code>unified_search_default_enabled</code>

: Whether this module is searchable via the global search by default.

; <code>duplicate_merge</code>

: Whether or not duplicate merging functionality is enabled for this module.

; <code>comment</code>

: A description of this module.

; <code>optimistic_locking</code>

: Whether optimistic should be enabled for this module. Optimistic locking locks concurrent edits on a record by assuming that there will be no conflict. On save the last modified timestamp on the record will be checked. If it is different then an edit has occurred since this record was loaded. If this is the case then the user will be prompted with a page showing the differences in the two edits and asked to choose which edits are to be used.



===== Fields =====



The field defines the behaviour and attributes of each field in the module.



; <code>name</code>

: The name of the field.

; <code>vname</code>

: The name of the language label to be used for this field.

; <code>type</code>

: The type of the field. See the field types section.

; <code>isnull</code>

: Whether null values are allowed

; <code>len</code>

: If the field is a string type, the max number of characters allowed.

; <code>options</code>

: For enum fields the language label for the dropdown values for this field

; <code>dbtype</code>

: The type to be used by the database to store this field. This is not required as the appropriate type is usually chosen.

; <code>default</code>

: The default value of this field.

; <code>massupdate</code>

: Whether or not this field should be mass updatable. Note that some field types are always restricted from mass updates.

; <code>rname</code>

: For related fields only. The name of the field to be taken from the related module.

; <code>id_name</code>

: For related fields only. The field in this bean which contains the related id.

; <code>source</code>

: The source of this field. Can be set to ‘non-db’ if the field is not stored in the database - for example for link fields, fields populated by logic hooks or by other means.

; <code>sort_on</code>

: For concatenated fields (i.e. name fields) the field which should be used to sort.

; <code>fields</code>

: For concatenated fields (i.e. name fields) an array of the fields which should be concatenated.

; <code>db_concat_fields</code>

: For concatenated fields (i.e. name fields) an array of the fields which should be concatenated in the database. Usually this is the same as fields.

; <code>unified_search</code>

: True if this field should be searchable via the global search.

; <code>enable_range_search</code>

: Whether the list view search should allow a range search of this field. This is used for date and numeric fields.

; <code>studio</code>

: Whether the field should display in studio.

; <code>audited</code>

: Whether or not changes to this field should be audited.



===== Field types =====



The following are common field types used:



; <code>id</code>

: An id field.

; <code>name</code>

: A name field. This is usually a concatenation of other fields.

; <code>bool</code>

: A boolean field.

; <code>varchar</code>

: A variable length string field.

; <code>char</code>

: A character field.

; <code>text</code>

: A text area field.

; <code>decimal</code>

: A decimal field.

; <code>date</code>

: A date field.

; <code>datetime</code>

: A date and time field.

; <code>enum</code>

: A dropdown field.

; <code>phone</code>

: A phone number field.

; <code>link</code>

: A link to another module via a relationship.

; <code>relate</code>

: A related bean field.



===== Indices =====



The indices array allows defining any database indexes that should be in place on the database table for this module. Let’s look at an example:



<div class="code-block">



Example 4.2: Example indices definition





-----



<div class="highlight">



<pre> 1 'indices' =&gt; array (

 2 	array(

 3 		'name' =&gt;'idx_mymod_id_del',

 4 		'type' =&gt;'index',

 5 		'fields'=&gt;array('id', 'deleted')),

 6 	array(

 7 		'name' =&gt;'idx_mymod_parent_id',

 8 		'type' =&gt;'index',

 9 		'fields'=&gt;array( 'parent_id')),

10 	array(

11 		'name' =&gt;'idx_mymod_parent_id',

12 		'type' =&gt;'unique',

13 		'fields'=&gt;array( 'third_party_id')),

14 	),</pre>



</div>



-----





</div>

Each array entry should have, at least, the following entries:



; name

: The name of the index. This is usually used by the database to reference the index. Most databases require that these are unique.

; type

: The type of the index to create. <code>index</code> will simply add an index on the fields, <code>unique</code> will add a unique constraint on the fields, <code>primary</code> will add the fields as a primary key.

; fields

: An array of the fields to be indexed. The order of this array will be used as the order of the fields in the index.



===== Relationships =====



The Vardefs also specify the relationships within this module. Here’s an edited example from the Accounts module:



<div class="code-block">



Example 4.3: Example relationships definition





-----



<div class="highlight">



<pre> 1 'relationships' =&gt; array (

 2 	'account_cases' =&gt; array(

 3 		'lhs_module'=&gt; 'Accounts',

 4 		'lhs_table'=&gt; 'accounts',

 5 		'lhs_key' =&gt; 'id',

 6 		'rhs_module'=&gt; 'Cases',

 7 		'rhs_table'=&gt; 'cases',

 8 		'rhs_key' =&gt; 'account_id',

 9 		'relationship_type' =&gt; 'one-to-many'),

10 ),</pre>



</div>



-----





</div>

Here we see the link between accounts and cases. This is specified with the following keys:



; <code>lhs_module</code>

: The module on the left hand side of this relationship. For a one to many relationship this will be the “One” side.

; <code>lhs_table</code>

: The table for the left hand side module. If you are unsure the table for a module can be found in it’s vardefs.

; <code>lhs_key</code>

: The field to use for the left hand side of this link. In this case it is the <code>id</code> of the account.

; <code>rhs_module</code>

: The right hand side module. In this case the “many” side of the relationship.

; <code>rhs_table</code>

: The table for the right hand side module. As stated previously you can find the table for a module can be found in it’s vardefs.

; <code>rhs_key</code>

: The field to use on the right hand side. In this case the <code>account_id</code> field on cases.

; <code>relationship_type</code>

: The type of relationship - “one-to-many” or “many-to-many”. Since this is a one to many relationship it means a case is related to a single account but a single account can have multiple cases.



For many to many relationship fields the following keys are also available:



; <code>join_table</code>

: The name of the join table for this relationship.

; <code>join_key_lhs</code>

: The name of the field on the join table for the left hand side.

; <code>join_key_rhs</code>

: The name of the field on the join table for the right hand side.



==== Vardef templates ====



Vardef templates provide a shortcut for defining common vardefs. This is done by calling <code>VardefManager::createVardef</code> and passing the module name, object name and an array of templates to be assigned. The following is an example from the accounts vardefs:



<div class="code-block">



Example 4.4: Example vardef template





-----



<div class="highlight">



<pre>22 VardefManager::createVardef(

23 		'Accounts',

24 		'Account',

25 		array('default', 'assignable','company',)

26 		);</pre>



</div>



-----





</div>

In this example the <code>default</code>, <code>assignable</code> and <code>company</code> templates are used. The following are some of the available templates:



; <code>basic</code><br />

<code>default</code>

: Adds the common base fields such as <code>id</code>, <code>name</code>, <code>date_entered</code>, etc.

; <code>assignable</code>

: Adds the fields and relationships necessary to assign a record to a user.

; <code>person</code>

: Adds fields common to people records such as <code>first_name</code>, <code>last_name</code>, address, etc.

; <code>company</code>

: Adds fields common to companies such as an industry dropdown, address, etc.



==== Customising vardefs ====



Vardefs can be customised by adding a file into



<div class="code-block">



Example 4.5: Custom vardef location





-----



<div class="highlight">



<pre>custom/Extension/modules/&lt;TheModule&gt;/Ext/SomeFile.php</pre>



</div>



-----





</div>

This file can then be used to add a new field definition or customise an existing one e.g changing a field type:



<div class="code-block">



Example 4.6: Example overriding an existing vardef





-----



<div class="highlight">



<pre>$dictionary[&quot;TheModule&quot;][&quot;fields&quot;][&quot;some_field&quot;]['type'] = 'int';</pre>



</div>



-----





</div>



</div>

<span id="chap04.xhtml"></span>



<div>



== <span class="section-number">5. </span>Views ==



SuiteCRM follows the MVC (Model-View-Controller) pattern and as such has the concept of views. Views are responsible for gathering and displaying data . There are a number of default views in SuiteCRM. These include



; ListView

: Displays a list of records and provides links to the EditViews and DetailViews of those records. The ListView also allows some operations such as deleting and mass updating records. This is (usually) the default view for a module.

; DetailView

: Displays the details of a single record and also displays subpanels of related records.

; EditView

: The EditView allows editing the various fields of a record and provides validation on these values.



=== Location ===



Views can be found in <code>modules/&lt;TheModule&gt;/views/</code> or, for custom views,<br />

<code>custom/modules/&lt;TheModule&gt;/views/</code>, and are named in the following format: <code>view.&lt;viewname&gt;.php</code>. For example, the Accounts DetailView can be found in <code>modules/Accounts/views/view.detail.php</code> with a customised version in <code>custom/modules/Accounts/views/view.detail.php</code>. The custom version is used if it exists. If it doesn’t then the module version is used. Finally, if neither of these exist then the SuiteCRM default is used in <code>include/MVC/View/views/</code>.



=== Customising ===



In order to customise a View we first need to create the appropriate view file. This will vary depending on the module we wish to target.



==== Custom module ====



In this case we can place the file directly into our module. Create a new file (if it doesn’t exist) at <code>modules/&lt;TheModule&gt;/views/view.&lt;viewname&gt;.php</code>. The contents will look similar to:



<div class="code-block">



Example 5.1: View for a custom module





-----



<div class="highlight">



<pre>1 &lt;?php

2 

3 require_once 'include/MVC/View/views/view.&lt;viewname&gt;.php';

4 

5 if(!defined('sugarEntry') || !sugarEntry) die('Not A Valid Entry Point');

6 class &lt;TheModule&gt;View&lt;ViewName&gt; extends View&lt;ViewName&gt;

7 {

8 

9 }</pre>



</div>



-----





</div>

A more concrete example would be for the detail view for a custom module called ABC_Vehicles:



<div class="code-block">



Example 5.2: Detail view for a custom module, ABC_Vehicles





-----



<div class="highlight">



<pre>1 &lt;?php

2 

3 require_once 'include/MVC/View/views/view.detail.php';

4 

5 if(!defined('sugarEntry') || !sugarEntry) die('Not A Valid Entry Point');

6 class ABC_VehiclesViewDetail extends ViewDetail

7 {

8 

9 }</pre>



</div>



-----





</div>

==== Preexisting modules ====



For preexisting modules you will want to add the view to<br />

<code>custom/modules/&lt;TheModule&gt;/views/view.&lt;viewname&gt;.php</code>.



The contents of this file will vary depending on whether you wish to extend the existing view (if it exists) or create your own version completely. It is usually best to extend the existing view, since this will retain important logic. Note the naming convention here. We name the class<br />

<code>Custom&lt;TheModule&gt;View&lt;ViewName&gt;</code> (for example <code>CustomAccountsViewDetail</code>).



Here we don’t extend the existing view or no such view exists:



<div class="code-block">



Example 5.3: Custom view for an existing module





-----



<div class="highlight">



<pre>1 &lt;?php

2 if(!defined('sugarEntry') || !sugarEntry) die('Not A Valid Entry Point');

3 

4 require_once 'include/MVC/View/views/view.&lt;viewname&gt;.php';

5 

6 class Custom&lt;TheModule&gt;View&lt;ViewName&gt; extends ViewDetail

7 {

8 

9 }</pre>



</div>



-----





</div>

Otherwise we extend the existing view. Note that we are requiring the existing view:



<div class="code-block">



Example 5.4: Overriding a view for an existing module





-----



<div class="highlight">



<pre>1 &lt;?php

2 if(!defined('sugarEntry') || !sugarEntry) die('Not A Valid Entry Point');

3 

4 require_once 'modules/&lt;TheModule&gt;/views/view.&lt;viewname&gt;.php';

5 

6 class Custom&lt;TheModule&gt;View&lt;ViewName&gt; extends &lt;TheModule&gt;View&lt;ViewName&gt;

7 {

8 

9 }</pre>



</div>



-----





</div>

For example, overriding the List View of Accounts:



<div class="code-block">



Example 5.5: Overriding the Accounts List View





-----



<div class="highlight">



<pre>1 &lt;?php

2 if(!defined('sugarEntry') || !sugarEntry) die('Not A Valid Entry Point');

3 

4 require_once 'modules/Accounts/views/view.list.php';

5 

6 class CustomAccountsViewList extends AccountsViewList

7 {

8 

9 }</pre>



</div>



-----





</div>

==== Making changes ====



Now that we have a custom view what can we actually do? The views have various methods which we can now override to change/add behaviour. The most common ones to override are:



; preDisplay

: Explicitly intended to allow logic to be called before display() is called. This can be used to alter arguments to the list view or to output anything to appear before the main display code (such as, for example, adding JavaScript).

; display

: Does the actual work of displaying the view. Can be overridden to alter this behaviour or to output anything after the main display. You usually want to call parent::display(); to ensure that the display code is run (unless, of course, you are adding your own display logic).





</div>

<span id="chap05.xhtml"></span>
